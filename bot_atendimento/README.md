# Instruções para Configuração do Banco de Dados e Autenticação (Bot de Atendimento)

## 1. Estrutura do Banco de Dados (RLS Ativo)

Crie as tabelas no Supabase com as seguintes definições SQL:

```sql
-- Tabela de Pedidos
create table public.orders (
  id bigint generated by default as identity not null,
  wa_id bigint null,
  nome text null,
  status text null,
  pedido jsonb null,
  valor_pedido numeric(10, 2) null,
  forma_de_pagamento jsonb null,
  updated_at timestamp without time zone null,
  context_message jsonb null,
  endereco jsonb null,
  commerce_id uuid not null,
  constraint orders_pkey primary key (id),
  constraint orders_commerce_id_fkey foreign key (commerce_id) references public.commerces (id)
) tablespace pg_default;

-- Tabela de Comércios
create table public.commerces (
  id uuid not null default gen_random_uuid(),
  name text not null,
  owner_id uuid not null,
  constraint commerces_pkey primary key (id),
  constraint commerces_owner_id_fkey foreign key (owner_id) references auth.users (id)
) tablespace pg_default;
```

Ative **RLS (Row Level Security)**:

```sql
alter table public.orders enable row level security;
alter table public.commerces enable row level security;
```

Crie **políticas de acesso** para permitir que cada usuário veja apenas seus próprios dados:

```sql
-- Políticas para commerces
create policy "Usuário vê seus próprios comércios" on public.commerces
  for select using (auth.uid() = owner_id);
create policy "Usuário insere comércios" on public.commerces
  for insert with check (auth.uid() = owner_id);

-- Políticas para orders
create policy "Usuário vê pedidos de seu comércio" on public.orders
  for select using (commerce_id in (select id from public.commerces where owner_id = auth.uid()));
create policy "Usuário insere pedidos vinculados ao seu comércio" on public.orders
  for insert with check (commerce_id in (select id from public.commerces where owner_id = auth.uid()));
```

---

## 2. Criar um Login de Teste no Supabase Auth

1. Vá até o **Supabase Dashboard** → aba **Authentication** → **Users**.
2. Clique em **Add User**.
3. Preencha os dados:

   * **Email:** `teste@bot.com`
   * **Password:** `123456`
   * **Confirm Email:** desmarcado (para testes locais)
4. Clique em **Create User**.

Anote o **UUID do usuário** para usar como `owner_id` ao criar um comércio de teste.

---

## 3. Inserir um Comércio de Teste

Execute no editor SQL do Supabase:

```sql
insert into public.commerces (name, owner_id)
values ('Comércio de Teste', 'UUID_DO_USUARIO_DE_TESTE');
```

Copie o `id` gerado — ele será o `commerce_id` usado nos pedidos.

---

## 4. Inserir Pedido de Teste

```sql
insert into public.orders (wa_id, nome, status, pedido, valor_pedido, forma_de_pagamento, context_message, endereco, commerce_id)
values (
  5599999999999,
  'Lucas Matheus',
  'aberto',
  '{"itens": ["Pizza Calabresa", "Coca 2L"]}',
  65.90,
  '{"tipo": "pix", "status": "pendente"}',
  '{"mensagem": "Olá, gostaria de pedir uma pizza."}',
  '{"rua": "Rua das Flores", "numero": 123}',
  'UUID_DO_COMERCIO_DE_TESTE'
);
```

---

## 5. Editar Credenciais nos Nodes (n8n, etc.)

1. Localize os nodes que utilizam o Supabase (geralmente **HTTP Request** ou **Supabase Node**).
2. Edite as credenciais:

   * **SUPABASE_URL:** `https://SEU_PROJETO.supabase.co`
   * **SUPABASE_KEY:** chave de serviço ou pública (de acordo com o nível de acesso).
3. Para testes, use o usuário `teste@bot.com` e senha `123456` para autenticação.
4. Verifique se os endpoints estão apontando para `https://SEU_PROJETO.supabase.co/rest/v1/`.

---

✅ **Pronto!** Agora o bot de atendimento pode interagir com os dados de pedidos e comércios de forma segura, usando RLS e autenticação real.
